from django.utils import unittest
from django.contrib.contenttypes.models import ContentType

from knotis.contrib.auth.models import (
    KnotisUser
)

from knotis.contrib.identity.models import (
    Identity,
    IdentityTypes,
    IdentityIndividual,
    IdentityBusiness,
    IdentityEstablishment
)

from knotis.contrib.relation.models import (
    Relation,
    RelationTypes
)


class IdentityTests(unittest.TestCase):
    @staticmethod
    def create_test_individual(**kwargs):
        if not kwargs.get('name'):
            kwargs['name'] = 'Test Individual'

        if not kwargs.get('description'):
            kwargs['description'] = 'Test Individual description.'

        return IdentityIndividual.objects.create(**kwargs)

    @staticmethod
    def create_test_business(**kwargs):
        if not kwargs.get('name'):
            kwargs['name'] = 'Test Business'

        if not kwargs.get('description'):
            kwargs['description'] = 'Test Business description.'

        return IdentityBusiness.objects.create(**kwargs)

    @staticmethod
    def create_test_establishment(**kwargs):
        if not kwargs.get('name'):
            kwargs['name'] = 'Test Establishment'

        if not kwargs.get('description'):
            kwargs['description'] = 'Test Establishment description.'

        return IdentityEstablishment.objects.create(**kwargs)

    def __init__(
        self,
        *args,
        **kwargs
    ):
        super(IdentityTests, self).__init__(
            *args,
            **kwargs
        )

        self.user = None
        self.user_password = 'test_password'
        self.user_email = 'fake@example.com'

        self.business_name = 'Fake Business'

    def setUp(self):
        pass

    def test_identity_creation(self):
        identity_type = IdentityTypes.INDIVIDUAL
        name = 'Test Identity'
        description = 'Test Description'

        created = Identity.objects.create(
            identity_type=identity_type,
            name=name,
            description=description,
            primary_image=None
        )

        selected = Identity.objects.get(pk=created.id)
        self.assertEqual(selected.name, name)
        self.assertEqual(selected.description, description)
        self.assertEqual(selected.identity_type, identity_type)

    def test_business_creation(self):
        user, user_identity = KnotisUser.objects.create_user(
            'Test',
            'User',
            self.user_email,
            self.user_password
        )

        business = IdentityBusiness.objects.create(
            user_identity,
            name=self.business_name
        )

        relation_type = ContentType.objects.get_for_model(business)
        relations = Relation.objects.filter(
            related_content_type=relation_type,
            related_object_id=business.id
        )

        owner = None

        for relation in relations:
            if relation.relation_type == RelationTypes.OWNER:
                owner = relation
                break

        self.assertIsNotNone(owner)
        self.assertEqual(
            user_identity.id,
            owner.subject.id
        )
