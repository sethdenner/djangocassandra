{% extends 'master.html' %}

{% block title %}Knotis - Dashboard{% endblock title %}

{% block content %}
<div id="content" class="back-offers">
    <div class="curve">
        <div class="wrapper clear-fix relative">
            {% include 'account_notifications.html' %}
            <div class="box-offers box-border left">
                <div class="clear-fix margin-general">
                    <ul class="filtering-bar-dash clear-fix">
                        <li class="txt-size"><a class="first active" href="#">Offers</a></li>
                        <li class="txt-size"><a class="first" href="/dashboard/qrcodes/">Qrcode Scans</a></li>
                        <li class="txt-size"><a class="coming-soon" href="#">Happy hour</a></li>
                        <li class="txt-size"><a class="coming-soon" href="#">Special event</a></li>
                    </ul>
                </div>
                <div class="offer_list_backend">
                    {% if offers %}
                    {% for offer in offers %}
                    {% if offer.orders %}
                    <div class="premiumoffers_filter margin-up">
                        <ul class="clear-fix graphic-buttoms-<?= $offer->id ?>">
                            <li><a class="active graphic-buttom" href="#"  data-id="{{ offer.id }}" data-type="year">Monthly</a></li>
                            <li><a href="#" class="graphic-buttom" data-id="{{ offer.id }}" data-type="week">Weekly</a></li>
                            <li><a href="#" class="graphic-buttom" data-id="{{ offer.id }}" data-type="days">Daily</a></li>
                        </ul>
                    </div>
                    <div class="clear-fix" id="graphic-{{ offer.id }}">
                        <script type="text/javascript">
                            var chart;
                            $(document).ready(function() {
                                chart = new Highcharts.Chart({
                                    chart: {
                                        renderTo: 'graphic{{ offer.id }}',
                                        defaultSeriesType: 'area'
                                    },
                                    title: {
                                        text: 'Sold'
                                    },
                                    xAxis: {
                                        categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec' ],
                                        tickmarkPlacement: 'on',
                                        title: {
                                            enabled: false
                                        }
                                    },
                                    yAxis: {
                                        title: {
                                            text: 'Dollars'
                                        },
                                        labels: {
                                            formatter: function() {
                                                return this.value;
                                            }
                                        }
                                    },
                                    tooltip: {
                                        formatter: function() {
                                            return '' +
                                                    this.x + ': ' + Highcharts.numberFormat(this.y, 0, ',') + ' Dollars';
                                        }
                                    },
                                    plotOptions: {
                                        area: {
                                            stacking: 'normal',
                                            lineColor: '#666666',
                                            lineWidth: 1,
                                            marker: {
                                                lineWidth: 1,
                                                lineColor: '#666666'
                                            }
                                        }
                                    },
                                    series: [
                                        {
                                            name: 'Total Sold',
                                            data: [
                                                {% for revenue in monthly_revenue %}
                                                {{ revenue }},
                                                {% endfor %}
                                            ]
                                        }
                                    ]
                                });
                            });
                        </script>
                        <div class="graphic" id="graphic{{ offer.id }}">
                        </div>
                    </div>
                    <ul class="information-dash ">
                        <li class="sold clear-fix radius-general">
                            <span class="left"><strong>Sold:</strong></span>
                            <span class="right second">{{ offer.purchase }}</span>
                        </li>
                        <li class="revenue radius-general clear-fix">
                            <span class="left"><strong>Revenue:</strong></span>
                            <span class="right second">${{ yearly_revenue }}</span>
                        </li>
                    </ul>
                    <div class="offers-div line-bottom clear-fix">
                        <div class="not-offers clear-fix">
                            <div class="offers-image radius-general left relative">
                                <div class="category food"></div>
                                <img alt=""
                                     src="{% if not offer.image %}images/layouts/knotis-offer-image.jpg{% else %}/images/thumb/72/72/{{ offer.image }}{% endif %}"
                                     class="image-knotis-thumb"/>
                            </div>
                            <div class="offers-txt left">
                                <h5><strong>{{ offer.title }}</strong></h5>
                                <ul class="date-dash clear-fix">
                                    <li>{{ offer.start_date }}</li>
                                    <li>{{ offer.end_date }}</li>
                                </ul>
                                <a class="txt-size margin-general clear-fix business"
                                   alt="{{ offer.business.business_name }}"
                                   title="{{ offer.business.business_name }}" target="_blank"
                                   href="/business/{{ offer.business.backend_name }}/">{{ offer.business.business_name }}</a>
                            </div>
                        </div>
                        <div class="not-offers left select-sort">
                		    <label for="sortby" class="left-side2 txt-size">
                			  Sort By:
                		    </label>
                			<div class="right">
                        	  <select id="sortby">
                        		<option value="0" >Username</option>
                        		<option value="1" >Code</option>
                			  </select>
                        	</div>
                        </div>
                	    <span class="not-offers right">
                	      <a id="print-offers" href="./printoffers" target="_blank" > 
                		    Print Unredeemed Offers <img class="print" src="{{ STATIC_URL }}images/layouts/print.png" />
                		  </a>
                		</span>
                        {% if offer.orders %}
                        {% for order in offer.orders %}
                        <div class="offer-div clear-fix clean reedem-code radius-general ">
                            <ul class="left txt-size">
                                <li><strong>User:</strong> {{ order.user.username }}</li>
                                <li><strong>Code:</strong>#{{ order.redemption_code }}</li>
                                <li><strong>Purchase Date:</strong> {{ order.formatted_date }}</li>
                              </ul>
                            <ul class="left txt-size" >
                                <li><strong>Stock:</strong> {{ order.pending }}</li>
                                <li><strong>Paid:</strong> ${{ order.price }}</li>
                                <li class="redeem"><strong>Redeemed:</strong> {{ order.redeemed }}</li>
                            </ul>
                            <form class="backend-setting" method="post">
                                <div class="offers-action offers-action-dash radius-general left">
                                    {% if order.redeemed != order.pending %}
                                    <label class="number-redeem left">
                                        <select name="stock_select">
                                            {% for n in order.redeem_numbers %}
                                            <option value="{{forloop.counter}}">{{ forloop.counter }}</option>
                                            {% endfor %}
                                        </select>
                                    </label>
                                    <input type="submit" class="button radius-general left"
                                           value="Redeem"/>
                                    <input type="hidden" value="{{ offer.id }}"
                                           name="offerOrderid"/>
                                    <input type="hidden" value="{{ order.redeemed }}"
                                           name="redeem_actual"/>
                                    {% endif %}
                                </div>
                            </form>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <p class="message-confirm message-info radius-general txt-size">No offers yet.</p>';
                    {% endif%}
                </div>
            </div>
            {% include 'dashboard_menu.html' with current_page='dashboard' %}
        </div>
    </div>
</div>
<script type="text/javascript" >
	$(function(){
	  $('#print-offers').help
	  
	  var sortOffers = function($offers, index) {
	      var $rows = $('.offer-div',$offers);
	      $rows.sort(function(a, b){
	          var keyA = $.trim($('ul li:eq(' + index + ')',a).remove('strong').text().toLowerCase());
	          var keyB = $.trim($('ul li:eq(' + index + ')',b).remove('strong').text().toLowerCase());
	          if (keyA === keyB) { return 0; }
	          return (keyA > keyB) ? 1 : -1;
	      });
	      $.each($rows, function(index, row){
	        $offers.append(row);
	      });
	  }
	  var $offers = $('.offers-div').remove('.not-offers');
	  sortOffers($offers, 0);
	  
	  $('#sortby').change(function(event) {
	  	event.preventDefault();
	  	sortOffers($offers, $(this).val());
	  });
	});
</script>
{% endblock content%}
